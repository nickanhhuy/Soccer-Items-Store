<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - HuSoccer Shop</title>
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success">
        <span th:text="${successMessage}"></span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-error">
        <span th:text="${errorMessage}"></span>
    </div>

    <div class="profile-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <!-- User Avatar and Info -->
            <div class="user-info">
                <div class="avatar-container">
                    <img th:src="${user.avatarUrl != null ? user.avatarUrl : '/image/default-avatar.png'}" 
                         alt="User Avatar" class="user-avatar">
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#account-details" class="nav-item active" onclick="showSection('account-details', event)">
                    <i class="icon-user"></i>
                    Account Details
                </a>
                <a href="#change-password" class="nav-item" onclick="showSection('change-password', event)">
                    <i class="icon-key"></i>
                    Change Password
                </a>
                <a href="#payment-methods" class="nav-item" onclick="showSection('payment-methods', event)">
                    <i class="icon-card"></i>
                    Payment Methods
                </a>
                <a href="#logout" class="nav-item" onclick="logout()">
                    <i class="icon-logout"></i>
                    Logout
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <a th:href="@{/menu}" class="back-link">‚Üê Back to Shop</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1>Account Settings</h1>
            </div>
            <!-- Account Details Section -->
            <section id="account-details" class="content-section active">
                <form th:action="@{/profile/update}" method="post" class="profile-form">
                    <div class="form-group">
                        <label class="form-label">Email address</label>
                        <input type="email" name="email" th:value="${user.email}" 
                               placeholder="Enter your email" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">First name</label>
                        <input type="text" name="firstName" th:value="${user.fullName != null ? user.fullName.split(' ')[0] : ''}" 
                               placeholder="Enter your first name" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Last name</label>
                        <input type="text" name="lastName" th:value="${user.fullName != null and user.fullName.contains(' ') ? user.fullName.substring(user.fullName.indexOf(' ') + 1) : ''}" 
                               placeholder="Enter your last name" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" name="phone" th:value="${user.phone}" 
                               placeholder="Enter your phone number" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" th:value="${user.userName}" 
                               placeholder="Username" class="form-input" disabled>
                        <small class="form-help">Username cannot be changed</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Save Changes</button>
                        <a th:href="@{/menu}" class="btn-secondary">Back to Shop</a>
                    </div>
                </form>
            </section>

            <!-- Change Password Section -->
            <section id="change-password" class="content-section">
                <form th:action="@{/profile/change-password}" method="post" class="profile-form">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" name="currentPassword" 
                               placeholder="Enter current password" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" name="newPassword" 
                               placeholder="Enter new password" class="form-input" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" name="confirmPassword" 
                               placeholder="Confirm new password" class="form-input" required minlength="6">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Change Password</button>
                    </div>
                </form>
            </section>

            <!-- Payment Methods Section -->
            <section id="payment-methods" class="content-section">
                <div class="section-header">
                    <h2>Payment Methods</h2>
                    <button class="btn-primary" onclick="showAddPaymentModal()">Add Payment Method</button>
                </div>

                <div class="payment-methods-list">
                    <div th:if="${paymentMethods != null and !paymentMethods.empty}">
                        <div th:each="payment : ${paymentMethods}" class="payment-card">
                            <div class="payment-info">
                                <div class="card-brand" th:text="${payment.cardType}"></div>
                                <div class="card-number" th:text="${payment.maskedCardNumber}"></div>
                                <div class="card-expiry">Expires <span th:text="${payment.formattedExpiry}"></span></div>
                                <div th:if="${payment.default}" class="default-badge">Default</div>
                            </div>
                            <div class="payment-actions">
                                <form th:if="${!payment.default}" th:action="@{'/profile/set-default-payment/' + ${payment.id}}" method="post" style="display: inline;">
                                    <button type="submit" class="btn-text">Set as Default</button>
                                </form>
                                <form th:action="@{'/profile/remove-payment-method/' + ${payment.id}}" method="post" style="display: inline;">
                                    <button type="submit" class="btn-text-danger" onclick="return confirm('Are you sure you want to remove this payment method?')">Remove</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div th:if="${paymentMethods == null or paymentMethods.empty}" class="empty-state">
                        <p>No payment methods added yet.</p>
                        <button class="btn-primary" onclick="showAddPaymentModal()">Add Your First Payment Method</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Payment Method Modal -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Payment Method</h3>
                <button class="modal-close" onclick="hideAddPaymentModal()">&times;</button>
            </div>
            <form th:action="@{/profile/add-payment-method}" method="post" class="payment-form">
                <div class="form-group">
                    <label class="form-label">Card Holder Name</label>
                    <input type="text" name="cardHolderName" placeholder="John Doe" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Card Number</label>
                    <div class="card-input-container">
                        <input type="text" name="cardNumber" placeholder="1234 5678 9012 3456" 
                               class="form-input" required maxlength="19" oninput="formatCardNumber(this)">
                        <span id="cardTypeDisplay" class="card-type-display"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Expiry Month</label>
                        <select name="expiryMonth" class="form-input" required>
                            <option value="">MM</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expiry Year</label>
                        <select name="expiryYear" class="form-input" required>
                            <option value="">YYYY</option>
                            <option th:each="year : ${#numbers.sequence(2024, 2034)}" 
                                    th:value="${year}" th:text="${year}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CVV</label>
                        <input type="text" name="cvv" placeholder="123" class="form-input" 
                               required maxlength="4" pattern="[0-9]{3,4}" oninput="formatCVV(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="setAsDefault" value="true">
                        Set as default payment method
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Add Payment Method</button>
                    <button type="button" class="btn-secondary" onclick="hideAddPaymentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showSection(sectionId, event) {
            event.preventDefault();
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        function showAddPaymentModal() {
            document.getElementById('addPaymentModal').style.display = 'flex';
        }

        function hideAddPaymentModal() {
            document.getElementById('addPaymentModal').style.display = 'none';
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue !== input.value) {
                input.value = formattedValue;
            }
            
            // Auto-detect card type
            const cardType = detectCardType(value);
            const cardTypeDisplay = document.getElementById('cardTypeDisplay');
            if (cardTypeDisplay) {
                cardTypeDisplay.textContent = cardType;
                cardTypeDisplay.className = 'card-type-display card-' + cardType.toLowerCase();
            }
        }
        
        function detectCardType(cardNumber) {
            const number = cardNumber.replace(/\s/g, '');
            if (number.startsWith('4')) return 'VISA';
            if (number.startsWith('5') || number.startsWith('2')) return 'MASTERCARD';
            if (number.startsWith('34') || number.startsWith('37')) return 'AMEX';
            if (number.startsWith('6')) return 'DISCOVER';
            return '';
        }
        
        function formatCVV(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addPaymentModal');
            if (event.target === modal) {
                hideAddPaymentModal();
            }
        }

        // Auto-hide alerts
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => alert.style.display = 'none');
        }, 5000);

        // Password confirmation validation
        const passwordForm = document.querySelector('#change-password form');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                const newPass = document.querySelector('input[name="newPassword"]').value;
                const confirmPass = document.querySelector('input[name="confirmPassword"]').value;
                if (newPass !== confirmPass) {
                    e.preventDefault();
                    alert('New passwords do not match!');
                }
            });
        }

        // Profile form handling
        const profileForm = document.querySelector('#account-details form');
        if (profileForm) {
            profileForm.addEventListener('submit', function(e) {
                const firstName = document.querySelector('input[name="firstName"]').value;
                const lastName = document.querySelector('input[name="lastName"]').value;
                
                // Combine first and last name into fullName
                const fullNameInput = document.createElement('input');
                fullNameInput.type = 'hidden';
                fullNameInput.name = 'fullName';
                fullNameInput.value = (firstName + ' ' + lastName).trim();
                this.appendChild(fullNameInput);
            });
        }
    </script>
</body>
</html>
